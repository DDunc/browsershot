#!/usr/bin/env node
var join = require('path').join;
var lodash = require('lodash');

var client = lodash.memoize(createClient);

var snap = {
  handler: function (args) {
    var urls = [args.url];
    client(args)
      .snap({ urls: urls, outputDir: args['output-dir'] })
      .then(
        console.log.bind(console),
        console.error.bind(console)
      )
      .then(function () {
        console.log('then done');
        return client(args).destroy();
      });
  },
  builder: function (yargs) {
    return yargs
      .option('--url', {
        alias: 'u',
        describe: 'url to snap',
      });
  }
};

function createClient(args) {
  var api = getBackend(args.backend);
  return api({
    username: args.username,
    password: args.password
  });
}

function listBrowsers(args) {
  client(args)
    .list()
    .then(
      console.log.bind(console),
      console.error.bind(console)
    );
}

function getBackend(backend) {
  switch(backend) {
    case 'browserstack-screenshot':
      return require('../lib/browserstack-screenshot');
    case 'phantomjs':
      return require('../lib/phantomjs');
  }
}

// Do the magic
var args = require('yargs')
  .usage('$0 <cmd> [args]')
  .config('config') // --config loads JSON
  .global(['config', 'output-dir']) // expose config JSON to subcommands
  .option('backend', {
    alias: 'b',
    describe: 'which backend to use to fetch the screenshots',
    choices: ['browserstack-screenshot', 'phantomjs']
  })
  .option('username', {
    alias: 'un',
    describe: 'username'
  })
  .option('password', {
    alias: 'pw',
    describe: 'password',
  })
  .option('output-dir', {
    alias: 'o',
    describe: 'directory to save screenshots',
    default: process.cwd(),
  })
  .command('list', 'list available browsers', { handler: listBrowsers, builder: {} })
  .command('snap', 'take a screenshots', snap)
  .help('help')
  .strict() // Any command-line argument given that is not demanded, or does not have a corresponding description, will be reported as an error.
  .argv;
